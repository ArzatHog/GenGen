<!DOCTYPE html>

<html onclick="jQuery('#txt').html(doGen('planet'));">
<head><title>GenGen</title></head>
<script src="jquery-3.2.0.min.js"></script>
<body style="background: #eeeeee;">
<script>
var structs = {};
var slots = {};

function doParse(text) {
    var struct = null;
    var value = null;
    text.split("\n").forEach(function(line) {
        var k = line.split(" ")[0];
        var v = line.substring(k.length + 1);
        if (k.length == 0 || v.length == 0) { return; }
        if (k == "struct") {
            value = null;
            struct = { slots: [], vals: {} };
            structs[v] = struct;
            return;
        }
        if (k == "slot") {
            struct.slots.push(v);
            if (!slots[v]) {
                slots[v] = [];
            }
            return;
        }
        if (k == "blocker") {
            value.blockers.push([v.split(" ")[0], v.split(" ")[1]]);
            return;
        }
        if (slots[k]) {
            struct = null;
            value = {"id": v, "blockers": []};
            slots[k].push(value);
            return;
        }
        if (struct) {
            struct.vals[k] = v;
        } else {
            value[k] = v;
        }
    });
    //console.log(structs);
    //console.log(slots);
}

function doGen(structID) {
    var result = {"struct": structs[structID]};
    structs[structID].slots.forEach(function(slot) {
        var availableSlots = slots[slot].filter(function(value) {
            return !value.blockers.some(function(blocker) {
                var blockerSlot = blocker[0];
                if (blockerSlot.indexOf(":") != -1) {
                    var blockerKey = blockerSlot.substring(blockerSlot.indexOf(":") + 1);
                    blockerSlot = blockerSlot.split(":")[0];
                    var blockerValue = blocker[1];
                    return result[blockerSlot] && result[blockerSlot][blockerKey] == blockerValue;
                } else{
                    var blockerID = blocker[1];
                    return result[blockerSlot] && result[blockerSlot].id == blockerID;
                }
            });
        });
        if (availableSlots.length == 0) {
            console.log(slot + " fail");
            console.log(result);
            availableSlots = slots[slot]; // qqDPS
        }
        result[slot] = availableSlots[Math.floor(Math.random() * availableSlots.length)];
    });
    return doExpand(structs[structID].vals["desc"], result).replace(/\\n/g, "<br>");
}

function doExpand(txt, context) {
    if (txt.indexOf("{") == -1) { return txt; }
    return txt.replace(/[{]([^}]*)[}]/g, function(m, capture) {
        if (capture.indexOf(":") == -1) {
            return context[capture].id;
        } else {
            var slot = capture.split(":")[0];
            var prop = capture.substring(slot.length + 1);
            return doExpand(context[slot][prop], context);
        }
    });
}

jQuery.ajax({
    url: "data.txt?" + (new Date()).getTime(),
    success: function(txt) { doParse(txt); jQuery("#txt").html(doGen("planet")); }
});
</script>
<div id="txt" style="font-size: 16pt; color: #222222; margin: auto; margin-top: 4em; width: 24em; line-height: 1.5;"></div>
</body>
</html>
