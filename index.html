<!DOCTYPE html>

<html onclick="doDisplay(doGen('planet'));">
<head><title>GenGen</title></head>
<script src="jquery-3.2.0.min.js"></script>
<style>
h1 { margin-top: 0; padding-top: 0; }
body {
    background: black;
    color: #222222;
    font-size: 16pt;
    line-height: 1.5;
}
#stats, #txt {
    background: #eeeeee;
    padding: 1em;
    border-radius: 1em;
    border: 4px solid white;
}
#stats {
    position: fixed;
    right: 0;
    padding-right: 2em;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}
#txt {
    padding-top: 0.5em;
    position: fixed;
    width: 24em;
}
</style>
<body>
<script>
var structs = {};
var slots = {};

function doParse(text) {
    var struct = null;
    var value = null;
    text.split("\n").forEach(function(line) {
        var k = line.split(" ")[0];
        var v = line.substring(k.length + 1);
        if (k.length == 0 || v.length == 0) { return; }
        if (k == "struct") {
            value = null;
            struct = { slots: [], vals: {} };
            structs[v] = struct;
            return;
        }
        if (k == "slot") {
            struct.slots.push(v);
            if (!slots[v]) {
                slots[v] = [];
            }
            return;
        }
        if (k == "blocker") {
            value.blockers.push([v.split(" ")[0], v.split(" ")[1]]);
            return;
        }
        if (slots[k]) {
            struct = null;
            value = {"id": v, "blockers": []};
            slots[k].push(value);
            return;
        }
        if (struct) {
            struct.vals[k] = v;
        } else {
            value[k] = v;
        }
    });
    //console.log(structs);
    //console.log(slots);
}

function doGen(structID) {
    var result = {"struct": structs[structID]};
    structs[structID].slots.forEach(function(slot) {
        var availableSlots = slots[slot].filter(function(value) {
            return !value.blockers.some(function(blocker) {
                var blockerSlot = blocker[0];
                if (blockerSlot.indexOf(":") != -1) {
                    var blockerKey = blockerSlot.substring(blockerSlot.indexOf(":") + 1);
                    blockerSlot = blockerSlot.split(":")[0];
                    var blockerValue = blocker[1];
                    return result[blockerSlot] && result[blockerSlot][blockerKey] == blockerValue;
                } else{
                    var blockerID = blocker[1];
                    return result[blockerSlot] && result[blockerSlot].id == blockerID;
                }
            });
        });
        if (availableSlots.length == 0) {
            console.log(slot + " fail");
            console.log(result);
            availableSlots = slots[slot]; // qqDPS
        }
        result[slot] = availableSlots[Math.floor(Math.random() * availableSlots.length)];
    });
    return result;
}

function doDisplay(result) {
    jQuery("#txt").html(doExpand(result.struct.vals["desc"], result)).
    css("top", (jQuery(window).height() / 2 - jQuery("#txt").height() / 2) + "px").
    css("left", (jQuery(window).width() / 2 - jQuery("#txt").width() / 2) + "px");
    jQuery("#stats").html(
        "Habitability: " + (Math.max(1, Math.min(9, eval(doExpand(result.struct.vals["hab"], result)))) * 10) + "%<br>" +
        "Size: " + (Math.max(1, Math.min(9, eval(doExpand(result.struct.vals["sze"], result))))) + "<br>" +
        "Industry: " + (Math.max(1, Math.min(9, eval(doExpand(result.struct.vals["min"], result))))) + "<br>" +
        "Science: " + (Math.max(1, Math.min(9, eval(doExpand(result.struct.vals["sci"], result)))))
    ).css("top", (jQuery(window).height() / 2 - jQuery("#stats").height() / 2) + "px");
}

function doExpand(txt, context) {
    if (!txt) { return ""; }
    if (txt.indexOf("{") == -1) { return txt; }
    return txt.replace(/[{]([^}]*)[}]/g, function(m, capture) {
        if (capture.indexOf(":") == -1) {
            return context[capture].id;
        } else {
            var slot = capture.split(":")[0];
            var prop = capture.substring(slot.length + 1);
            return doExpand(context[slot][prop], context);
        }
    });
}

jQuery.ajax({
    url: "data.txt?" + (new Date()).getTime(),
    success: function(txt) { doParse(txt); doDisplay(doGen("planet")); }
});
</script>
<div id="stats"></div>
<div id="txt"></div>
</body>
</html>
